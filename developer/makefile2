JAVAC         = $(JAVA_HOME)/bin/javac
JAR           = $(JAVA_HOME)/bin/jar
ANTLR_JAR     = ../tool/executor/antlr-4.9.2-complete.jar
JAVA_DIR      = javac
JVM_DIR       = jvm
ANTLR_DIR     = ANTLR
ANTLR_GEN_DIR = javac/antlr

# Source files
JAVA_SOURCES   = $(wildcard $(JAVA_DIR)/*.java)
ANTLR_GRAMMARS = $(wildcard $(ANTLR_DIR)/*.g4)

# Generated ANTLR Java files
ANTLR_GENERATED_SOURCES = $(patsubst $(ANTLR_DIR)/%.g4,$(ANTLR_GEN_DIR)/%.java,$(notdir $(ANTLR_GRAMMARS)))

.PHONY: all
all: setup $(ANTLR_GENERATED_SOURCES) $(JAVA_SOURCES:.java=.class) $(JVM_DIR)/GQLEchoParser.jar

.PHONY: variable
variable:
	$(info JAVAC is '$(JAVAC)')
	$(info JAR is '$(JAR)')
	$(info ANTLR_JAR is '$(ANTLR_JAR)')
	$(info JAVA_DIR is '$(JAVA_DIR)')
	$(info JVM_DIR is '$(JVM_DIR)')
	$(info ANTLR_DIR is '$(ANTLR_DIR)')
	$(info ANTLR_GEN_DIR is '$(ANTLR_GEN_DIR)')
	$(info JAVA_SOURCES is '$(JAVA_SOURCES)')
	$(info ANTLR_GRAMMARS is '$(ANTLR_GRAMMARS)')
	$(info ANTLR_GENERATED_SOURCES is '$(ANTLR_GENERATED_SOURCES)')

.PHONY: version
version:
	@ $(JAVAC) --version
	@ $(JAR) --version
	@ echo $(ANTLR_JAR)
	@ make -v | head -n 1

.PHONY: setup
setup:
	mkdir -p $(JVM_DIR)
	mkdir -p $(JAVA_DIR)/gql
	mkdir -p $(ANTLR_GEN_DIR)

.PHONY: clean
clean:
	rm -rf $(JVM_DIR)/*
	rm -rf $(ANTLR_GEN_DIR)/*.java

# Compile ANTLR grammars
$(ANTLR_GEN_DIR)/%.java: $(ANTLR_DIR)/%.g4
	java -jar $(ANTLR_JAR) -Dlanguage=Java -o $(@D) $<

# Compile Java sources
$(JVM_DIR)/%.class: $(JAVA_DIR)/gql/%.java $(ANTLR_GENERATED_SOURCES)
	$(JAVAC) -d $(JVM_DIR) -cp $(ANTLR_JAR) $<

# Create jar file
$(JVM_DIR)/GQLEchoParser.jar: $(patsubst $(JAVA_DIR)/gql/%.java,$(JVM_DIR)/%.class,$(JAVA_SOURCES))
	$(JAR) cvf $@ -C $(JVM_DIR) .
